@startuml (id=loop)
!include <tupadr3/common>
!include <tupadr3/font-awesome-5/cog>
!include <tupadr3/font-awesome-5/pen_square>
!include <tupadr3/font-awesome-5/user_alt>
!include <tupadr3/font-awesome-5/user_cog>
!include <tupadr3/font-awesome-5/user_edit>
!include <tupadr3/font-awesome-5/question>
!include <tupadr3/font-awesome-5/question_circle>
!include <tupadr3/font-awesome-5/puzzle_piece>

skinparam defaultTextAlignment center
skinparam defaultFontName Ubuntu Mono
skinparam defaultFontSize 15
scale max 1200 width

left to right direction

<style>
  rectangle {
    FontSize 20
  }
  collections {
    FontSize 20
  }
  label {
    FontSize 16
  }
  .axis {
    FontSize 12
    FontColor DimGrey
  }
  .sth {
  }
  .nth {
    FontSize 12
    FontColor Transparent
  }
  .puzzler {
    FontSize 50
    FontStyle bold
  }
</style>

!procedure $fill_player($style=sth)
  label origin <<$style>> [
    <$user_alt>
    игрок
  ]
!endprocedure

!procedure $fill_players()
  label origin [
    <$user_alt{scale=0.4}>
    <$user_alt{scale=0.4}>  <$user_alt{scale=0.4}>
    <$user_alt{scale=0.4}>
    игроки
  ]
!endprocedure

!procedure $fill_character()
  rectangle character [
    <$pen_square{scale=0.4}><size:8> </size>персонаж
  ]
!endprocedure

!procedure $hideCharacter()
  $fill_character()
  hide character
!endprocedure

!procedure $emptyCharacter()
  label character [
  ]
!endprocedure

!procedure $fill_characters()
  collections character [
    <$pen_square{scale=0.4}><size:8> </size>персонажи
  ]
!endprocedure

!procedure $fill_avatar()
  rectangle avatar [
    <$cog{scale=0.4}><size:8> </size>аватар
  ]
!endprocedure

!procedure $hideAvatar()
  $fill_avatar()
  hide avatar
!endprocedure

!procedure $emptyAvatar()
  label avatar [
  ]
!endprocedure

!procedure $fill_avatars()
  collections avatar [
    <$cog{scale=0.4}><size:8> </size>аватары
  ]
!endprocedure

!procedure $fill_legend()
  $fill_legend_x()
  $fill_legend_y()
!endprocedure

!procedure $fill_legend_x($style=axis)
  label leftmost <<$style>> [
    н
    а
    р
    р
    а
    т
    и
    в
  ]
  label rightmost <<$style>> [
    г
    е
    й
    м
    п
    л
    е
    й
  ]
!endprocedure

!procedure $hideLegendX()
  $fill_legend_x()
  hide leftmost
  hide rightmost
!endprocedure

!procedure $fill_legend_y($style=axis)
  label highest <<$style>> [
    р а ц и о
  ]
  label lowest <<$style>> [
    э м о ц и о
  ]
!endprocedure

!procedure $hideLegendY()
  $fill_legend_x()
  hide highest
  hide lowest
!endprocedure

!procedure $empty_legend()
  $empty_legend_x()
  $empty_legend_y()
!endprocedure

!procedure $empty_legend_x()
  label leftmost <<axis>> [
  ]
  label rightmost <<axis>> [
  ]
!endprocedure

!procedure $empty_legend_y()
  label highest <<axis>> [
  ]
  label lowest <<axis>> [
  ]
!endprocedure

!procedure $join_legend_1x1($x, $y="hidden")
  leftmost ~[$x]d~ origin
  origin ~[$x]d~ rightmost
  highest ~[$y]r~ origin
  origin ~[$y]r~ lowest
!endprocedure

!procedure $join_legend_3x1($x, $y="hidden")
  leftmost ~[$x]d~ character
  avatar ~[$x]d~ rightmost
  highest ~[$y]r~ origin
  origin ~[$y]r~ lowest
!endprocedure

!procedure $join_legend_3x3($x, $y="hidden")
  leftmost ~[$x]d~ character
  avatar ~[$x]d~ rightmost
  highest ~[$y]r~ upper
  lower ~[$y]r~ lowest
!endprocedure

!procedure $join_legend_5x1($x, $y="hidden")
  leftmost ~[$x]d~ master
  engine ~[$x]d~ rightmost
  highest ~[$y]r~ origin
  origin ~[$y]r~ lowest
!endprocedure

!procedure $join_legend_5x3($x, $y="hidden")
  leftmost ~[$x]d~ master
  engine ~[$x]d~ rightmost
  highest ~[$y]r~ upper
  lower ~[$y]r~ lowest
!endprocedure

!procedure $fillPlot()
  label plot [
    сюжет
  ]
!endprocedure

!procedure $fillTheme()
  label theme [
    тема
  ]
!endprocedure

!procedure $fillMasterMatrix()
  label plot [
    сюжет
  ]
  label theme [
    тема
  ]
  plot -[hidden]r- character
  character -[hidden]r- theme
!endprocedure

!procedure $fillMechanics()
  label mechanics [
    механика
  ]
!endprocedure

!procedure $fillSetting()
  label setting [
    сеттинг
  ]
!endprocedure

!procedure $fill_matrix()
  $fillPlot()
  $fillTheme()
  $fillSetting()
  $fillMechanics()
!endprocedure

!procedure $puzzle_matrix()
  $fill_puzzle(plot)
  $fill_puzzle(mechanics)
  $fill_puzzle(setting)
  $fill_puzzle(theme)
!endprocedure

!procedure $join_matrix()
  ' plot -[hidden]r- character
  ' character -[hidden]r- theme
  ' mechanics -[hidden]r- avatar
  ' avatar -[hidden]r- setting
  plot -[hidden]d- upper
  upper -[hidden]d- mechanics
  theme -[hidden]d- lower
  lower -[hidden]d- setting
!endprocedure

!procedure $fillEngineMatrix()
  label mechanics [
    механика
  ]
  label setting [
    сеттинг
  ]
  mechanics -[hidden]r- avatar
  avatar -[hidden]r- setting
!endprocedure

!procedure $fillGameMatrix()
  $fillMasterMatrix()
  $fillEngineMatrix()
!endprocedure

!procedure $fillGameLoop()
  $fill_characters()
  $fill_avatars()

  FA5_USER_EDIT(master, "мастер ", label)

  character -u-> master
  master ~[thickness=1]d~ character
  master -d-> character
  
  character -d-> origin
  character ~[thickness=1]d~ origin
  origin -u-> character

  FA5_USER_COG(engine, "движок ", label)

  avatar -u-> origin
  origin ~[thickness=1]d~ avatar
  origin -d-> avatar
  
  avatar -d-> engine
  avatar ~[thickness=1]d~ engine
  engine -u-> avatar

  $fillGameGrid()
!endprocedure

!procedure $fill_master()
  FA5_USER_EDIT(master, "мастер ", label)
!endprocedure

!procedure $emptyMaster()
  label master [
  ]
!endprocedure

!procedure $fill_engine()
  FA5_USER_COG(engine, "движок ", label)
!endprocedure

!procedure $fill_puzzle($key)
  label $key <<puzzler>> [
    ?
  ]
!endprocedure

!procedure $emptyEngine()
  label engine [
  ]
!endprocedure

!procedure $emptyGameLoop()
  label character [
  ]
  label avatar [
  ]

  leftmost ~[thickness=1]d~ character
  character ~[thickness=1]d~ origin
  origin ~[thickness=1]d~ avatar
  avatar ~[thickness=1]d~ rightmost

  $fillVertical()
!endprocedure

!procedure $fillGameGrid()
  $fillHorizontal()
  $fillVertical()
!endprocedure

!procedure $fillHorizontal()
  leftmost ~[thickness=1]d~ master
  engine ~[thickness=1]d~ rightmost
!endprocedure

!procedure $empty_grid_1x3()
  $fill_player()
  label upper [
  ]
  label lower [
  ]
!endprocedure

!procedure $empty_grid_3x3()
  $emptyCharacter()
  $fill_player()
  $emptyAvatar()
  label upper [
  ]
  label lower [
  ]
!endprocedure

!procedure $fill_grid_3x1()
  $fill_characters()
  $fill_players()
  $fill_avatars()
!endprocedure

!procedure $join_grid_3x1($mode)
  character ~[$mode]d~ origin
  origin ~[$mode]d~ avatar
!endprocedure

!procedure $fill_grid_5x1()
  $fill_master()
  $fill_grid_3x1()
  $fill_engine()
!endprocedure

!procedure $join_grid_5x1($mode)
  master ~[$mode]d~ character
  $join_grid_3x1($mode)
  avatar ~[$mode]d~ engine
!endprocedure

!procedure $join_grid_1x3($mode)
  upper ~[$mode]r~ origin
  origin ~[$mode]r~ lower
!endprocedure

!procedure $join_grid_3x3($mode)
  $join_grid_3x1($mode)
  $join_grid_1x3($mode)
!endprocedure

!procedure $join_grid_5x3($mode)
  $join_grid_5x1($mode)
  $join_grid_1x3($mode)
!endprocedure

!procedure $fillVertical()
  highest ~[thickness=1]r~ origin: \n
  origin ~[thickness=1]r~ lowest: \n
!endprocedure

!procedure $hiddenGameGrid()
  leftmost ~[hidden]d~ origin
  origin ~[hidden]d~ rightmost
!endprocedure

!procedure $fillGameStruct($count)
  !if ($count == 1)
    $fill_character()
    $fill_player()
    $fill_avatar()
  !else
    $fill_characters()
    $fill_players()
    $fill_avatars()
  !endif

  leftmost ~[hidden]d~ master
  master ~[hidden]d~ character
  character ~[hidden]d~ origin
  origin ~[hidden]d~ avatar
  avatar ~[hidden]d~ engine
  engine ~[hidden]d~ rightmost
!endprocedure

!$debug = 0
!if ($debug)
  $fill_puzzle(foo)
!endif
@enduml
